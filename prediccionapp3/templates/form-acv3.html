{% extends "plantilla.html" %}
{% block title %} IDENTIFICACIÓN DE GRUPOS | Hábitos {% endblock title %}

{% load crispy_forms_tags %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
<style>
    .card-header{       
        color: white;
        background: #56CCF2;  /* fallback for old browsers */
        background: -webkit-linear-gradient(to left, #56CCF2, #2F80ED);  /* Chrome 10-25, Safari 5.1-6 */
        background: linear-gradient(to left,  #56CCF2, #2F80ED);
    }

    input[name="username"],[name="password"], [name="first_name"], [name="last_name"],[name="email"]
    {
        height: 30px;
        font-family: "Red Hat Display", sans-serif;       
        font-optical-sizing: auto;
        font-weight: 500;
        font-size: 13px;
    }
    label{
        color: black;
    }
    hr{
        background-color: black;
    }

</style>
<div class="px-5">
    <div class="card mx-5 my-4 ">
        <div class="card-header">
            <h4 class="card-title pl-5 pt-2" style="font-size: 18px;"><i class="fa-solid fa-plus mr-2"></i><b> IDENTIFICACIÓN DE GRUPOS | Hábitos </b></h4>         
        </div>       
        <div class="card-body px-5">            
            <form id="prediction-form">
                {% csrf_token %}
                <h5 style="color: black;">GRUPO</h5>
                <hr style="color: black;">

                <div class="row">
                    <div class="col-6 col-sm-4">
                        <div class="form-group">
                            <label for="edadRango">Rango de Edad</label>
                            <select style="background-color: #fff; border-color: rgb(209, 215, 220); color: black;" class="form-select" id="edadRango" name="edadRango" required>
                                <option value="" disabled selected>Seleccionar opción</option>
                                <option value="0">18-24</option>
                                <option value="1">25-29</option>
                                <option value="2">30-34</option>
                                <option value="3">35-39</option>
                                <option value="4">40-44</option>
                                <option value="5">45-49</option>
                                <option value="6">50-54</option>
                                <option value="7">55-59</option>
                                <option value="8">60-64</option>
                                <option value="9">65-69</option>
                                <option value="10">70-74</option>
                                <option value="11">75-79</option>
                                <option value="12">80 or más</option>
                            </select>
                        </div>
                    </div>    
                    <div class="col-6 col-sm-2"></div>
                    <div class="col-6 col-sm-3">
                        <div class="form-group">
                            <label for="genero">Género</label>
                            <select style="background-color: #fff; border-color: rgb(209, 215, 220); color: black;" class="form-select" id="genero" name="genero" required>
                                <option value="" disabled selected>Seleccionar opción</option>
                                <option value="0">Femenino</option>
                                <option value="1">Masculino</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3">
                        <div class="form-group">
                            <label for="etnia">Etnia</label>
                            <select style="background-color: #fff; border-color: rgb(209, 215, 220); color: black;" class="form-select" id="etnia" name="etnia" required>
                                <option value="" disabled selected>Seleccionar opción</option>
                                <option value="0">Indígena</option>
                                <option value="1">Asiático</option>
                                <option value="2">Negro</option>
                                <option value="3">Hispano</option>
                                <option value="5">Blanco</option>
                                <option value="4">Otro</option>
                            </select>
                        </div>
                    </div>
                </div>

                <h5 style="color: black;">HÁBITOS</h5>
                <hr style="color: black;">

                <div class="row">
                    <div class="col-6 col-sm-3">
                        <div class="form-group">
                            <label for="fumador">Fumador Frecuente</label>
                            <select style="background-color: #fff; border-color: rgb(209, 215, 220); color: black;" class="form-select" id="fumador" name="fumador" required>
                                <option value="" disabled selected>Seleccionar opción</option>
                                <option value="0">No</option>
                                <option value="1">Sí</option>
                            </select>
                        </div>
                    </div>    

                    <div class="col-6 col-sm-3">
                        <div class="form-group">
                            <label for="bebedorFrecuente">Bebedor Frecuente</label>
                            <select style="background-color: #fff; border-color: rgb(209, 215, 220); color: black;" class="form-select" id="bebedorFrecuente" name="bebedorFrecuente" required>
                                <option value="" disabled selected>Seleccionar opción</option>
                                <option value="0">No</option>
                                <option value="1">Sí</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-6 col-sm-1"></div>

                    <div class="col-6 col-sm-3">
                        <div class="form-group">
                            <label for="actividadFisica">Actividad Física Frecuente</label>
                            <select style="background-color: #fff; border-color: rgb(209, 215, 220); color: black;" class="form-select" id="actividadFisica" name="actividadFisica" required>
                                <option value="" disabled selected>Seleccionar opción</option>
                                <option value="0">No</option>
                                <option value="1">Sí</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-6 col-sm-2">
                        <div class="form-group">
                            <label for="horasDormidas">Horas Dormidas c/d</label>
                            <input type="number" class="form-control" id="horasDormidas" name="horasDormidas" step="1" required>
                        </div>
                    </div>

                </div>

                <br>
                <div class="row">
                    <div class="col-6 col-sm-6">
                        <button style="width: 100%;" type="button" class="btn btn-primary" onclick="validateForm()">Enviar</button>
                    </div>
                    <div class="col-6 col-sm-6">
                        <a style="width: 100%;" type="button" class="btn btn-secondary" href="{% url 'home' %}">Regresar</a>
                    </div>
                </div>
            </form>    

            <div id="result" class="mt-4"></div>

        </div>
    </div>
</div>


{% endblock content %}

{% block js %}
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% if messages %}
        {% for m in messages %}
            <script>
                Swal.fire({
                "title": "Warning",
                "text":"{{m}}",
                "icon":"info"
                })
            </script>
        {% endfor %}
    {% endif %}

    <script>
        function validateForm() {
            const form = document.getElementById('prediction-form');
            let isValid = true;
            let errorMessage = "";

            // Check each required field
            const requiredFields = ['fumador', 'bebedorFrecuente', 'actividadFisica', 'horasDormidas', 'edadRango', 'genero', 'etnia'];
            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                if (!element.value) {
                    isValid = false;
                    errorMessage += `El campo ${element.previousElementSibling.innerText} es obligatorio.<br>`;
                }
            });

            const horas = parseFloat(document.getElementById('horasDormidas').value);

            if (isNaN(horas) || !Number.isInteger(horas) || horas < 1 || horas > 20) {
                isValid = false;
                errorMessage += "Las horas dormidas debe ser un número entero entre 1 y 20.<br>";
            }

            if (!isValid) {
                document.getElementById('result').innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
            } else {
                submitForm();
            }
        }

        function submitForm() {
            const form = document.getElementById('prediction-form');
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            console.log('Datos a enviar:', data); // Console log para ver los datos

        $.ajax({
                url: 'http://127.0.0.1:8080/api/acv3',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    let prediction = response.prediction[0]; 
                    let message;
                    if (prediction === 0) {
                        message = 'Pertenece al grupo de precaución mayor';
                    } else if (prediction === 1) {
                        message = 'Pertenece al grupo de precaución menor';
                    } else {
                        message = 'Pertenece al grupo de precaución intermedia';
                    }
                    $('#result').html('<div class="alert alert-success">Predicción: ' + message + '</div>');
                },
                error: function(xhr) {
                    $('#result').html('<div class="alert alert-danger">Error: ' + xhr.responseJSON.error + '</div>');
                }
            }); 
        }
    </script>
{% endblock %} 

